def latestSuccess = env.LATEST_SUCCESS
def numOfCommits

node {
  agent any
  // If there is a latest success build
  if(latestSuccess != "NULL") {
    numOfCommits = countCommits() + env.NUM_OF_COMMITS
  }
  if(latestSuccess == "NULL" || numOfCommits <= 8) {
    stages {
      stage("Build") {
        steps {
          sh 'mvn clean'
        }
      }
      stage("Test") {
        steps {
          sh 'mvn test'
        }
      }
      stage("Package") {
        steps {
          sh 'mvn package'
        }
      }
      stage("Deploy") {
        steps {
          slackSend channel: 'builds', message: "Build Sucessful ${env.JOB_NAME} ${env.BUILD_NUMBER} (<${env.BUILD_URL}|Open>)"
        }
      }
      if(currentBuild.currentResult == "SUCCESS") {
        env.LATEST_SUCCESS = currentBuild.id
        env.NUM_OF_COMMITS = 0
      }
    }
  }
}

def countCommits() {
  def changeLogs = currentBuild.changeSets
  def commits = 0
  for(int i = 0; i < changeLogs.size(); i++) {
    def entries = changeLogs[i].items
    //Count the commits
    for(int j = 0; j < entries.length; j++) {
      commits++
    }
  }
  return commits
}
